setwd("~/Desktop/SiFINeT/Result_server")
library(cogena)
data <- gmt2list("~/Downloads/c7.all.v2023.1.Hs.symbols.gmt")
a <- names(data)
b1 <- grepl("TCELL_VS_BCELL_UP", a, fixed = TRUE)
d1 <- unlist(data[b1])
b2 <- grepl("TCELL_VS_BCELL_DN", a, fixed = TRUE)
d2 <- unlist(data[b2])
e1 <- table(d1)
upgenes <- names(e1)[e1 >= 2]
e2 <- table(d2)
dngenes <- names(e2)[e2 >= 2]
rm(a,b1,b2,d1,d2,e1,e2)
setwd("~/Desktop/SiFINeT/Result/Experimental/TCell/")
library(Matrix)
cell_annotation <- readRDS("OriginalData/multi_annotation.rds")
cellidx <- which(cell_annotation %in% c("CD8 Naive", "CD4 Naive",
"Intermediate B", "Memory B", "Naive B"))
data <- readRDS("OriginalData/multi_rna_data.rds")
data <- data[, cellidx]
genenames <- rownames(data)
# atacseq no mito
rpc <- colSums(data)
idx <- which(rpc <= 1.8 * mean(rpc))
data <- data[, intersect(idx, idx)]
idx <- which(colSums(data > 0) > 0.02 * nrow(data))
data <- data[, idx]
idx <- which(rowSums(data > 0) > 0.02 * ncol(data))
data <- data[idx, ]
genenames <- genenames[idx]
library(SiFINeT)
so <- create_SiFINeT_object(data, gene.name = genenames)
library(cogena)
data <- gmt2list("~/Downloads/c7.all.v2023.1.Hs.symbols.gmt")
a <- names(data)
b1 <- grepl("TCELL_VS_BCELL_UP", a, fixed = TRUE)
d1 <- unlist(data[b1])
b2 <- grepl("TCELL_VS_BCELL_DN", a, fixed = TRUE)
d2 <- unlist(data[b2])
e1 <- table(d1)
upgenes <- names(e1)[e1 >= 2]
e2 <- table(d2)
dngenes <- names(e2)[e2 >= 2]
rm(a,b1,b2,d1,d2,e1,e2)
group1id <- match(tolower(upgenes), tolower(so@gene.name))
group1id
group1id <- group1id[!is.na(group1id)]
group2id <- match(tolower(dngenes), tolower(so@gene.name))
group2id <- group2id[!is.na(group2id)]
library(Seurat)
library(ggplot2)
library(ggpubr)
library(mclust)
library(tidyverse)
library(cogena)
library(Matrix)
setwd("~/Desktop/SiFINeT/Result_server/")
# Supp Fig 1
setwd("Numerical/SD1/")
data <- readRDS("data/19_matrix.rds")
group1 <- readRDS("data/19_cluster_true.rds")
group2 <- readRDS("data/19_cluster_seurat_k.rds")
group3 <- readRDS("data/19_cluster_seurat_d.rds")
colnames(data) <- 1:ncol(data)
rownames(data) <- 1:nrow(data)
so <- CreateSeuratObject(data)
so <- NormalizeData(so)
so <- FindVariableFeatures(so, selection.method = "vst", nfeatures = 500)
all.genes <- rownames(so)
so <- ScaleData(so, features = all.genes)
so <- RunPCA(so, features = VariableFeatures(object = so))
so <- FindNeighbors(so, dims = 1:10)
so <- FindClusters(so)
so <- RunUMAP(so, dims = 1:10)
so <- AddMetaData(so, data.frame(group1, group2, group3))
g1 <- DimPlot(so, reduction = "umap", group.by = "group1") +
labs(title = NULL) +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank()
)
g2 <- DimPlot(so, reduction = "umap", group.by = "group2") +
labs(title = NULL) +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank()
)
g3 <- DimPlot(so, reduction = "umap", group.by = "group3") +
labs(title = NULL) +
theme(axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank()
)
ggarrange(g1, g2, g3, nrow = 1, labels = "auto")
ggsave("../../Supp_Fig1.jpeg", width = 8, height = 2.5,
units = "in", device='jpeg', dpi=600)
# Supp Fig 2
# In plot2
# Supp Fig 3
# In plot3
# Supp Fig 4
setwd("../../Experimental/BoneMarrow")
set.seed(1)
selected_gene <- c("Gata2")
data <- readRDS("matrix.rds")
color <- data[match(selected_gene, rownames(data)), ]
gsvares <- readRDS("gsva_res.rds")
gsvares <- rbind(gsvares[2,], gsvares[1,])
plotdata1 <- data.frame(cbind(t(gsvares), color))
colnames(plotdata1) <- c("GSVA_layer1_GS1", "GSVA_layer1_GS2", "Expression")
g1 <- ggplot() +
geom_point(data = plotdata1, aes(x = GSVA_layer1_GS1, y = GSVA_layer1_GS2, color = Expression), size = 0.01) +
scale_colour_gradient2(low="navy", mid="white", high="red", midpoint = -0.2) +
theme_bw() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "black"),
legend.text=element_text(size=10,face="bold"),
legend.title=element_text(size=10,face="bold"))
g3 <- g1  +
annotate(geom = "segment", x = 0, xend = -0.65, y = -0.65, yend = -0.65) +
annotate(geom = "segment", x = 0, xend = -0.65, y = 0, yend = 0) +
annotate(geom = "segment", x = 0, xend = 0, y = 0, yend = -0.65) +
annotate(geom = "segment", x = -0.65, xend = -0.65, y = 0, yend = -0.65)
g3
ggsave("../../Supp_Fig4.jpeg", width = 3, height = 2.5,
units = "in", device='jpeg', dpi=600)
# Supp Fig 5
setwd("../MassiveRNA/")
timeres <- read.table("time_res.txt")
timeres <- timeres[, 3]
memres <- read.table("mem_res.txt")
memres <- memres[,2]
time_mem_data <- data.frame(ncell = c(10000, 20000, 50000, 100000, 200000, 400000,
600000, 800000, 1000000, 1287071),
total_time = timeres, peak_memory = memres)
time_mem_data$log_ncell <- log10(time_mem_data$ncell)
time_mem_data$log_total_time <- log10(time_mem_data$total_time)
time_mem_data$log_peak_memory <- log10(time_mem_data$peak_memory)
p1 <- ggplot(time_mem_data, aes(log_ncell, log_total_time)) +
geom_point(size = 3) +
geom_smooth(method="lm") +
labs(x = "log10 number of cells", y = "log10 time cost (s)") +
theme_bw() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "black"),
legend.text=element_text(face="bold"),
legend.title=element_blank()) +
annotate("text",x=4.5,y=4.5,label=(paste("Slope =",round(coef(lm(time_mem_data$log_total_time~time_mem_data$log_ncell))[2], 3))))
p2 <- ggplot(time_mem_data, aes(log_ncell, log_peak_memory)) +
geom_point(size = 3) +
geom_smooth(data=subset(time_mem_data, log_ncell >= 5), method="lm") +
geom_smooth(data=subset(time_mem_data, log_ncell < 5), method="lm") +
labs(x = "log10 number of cells", y = "log10 peak memory usage (MB)") +
theme_bw() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.border = element_blank(),
axis.line = element_line(colour = "black"),
legend.text=element_text(face="bold"),
legend.title=element_blank()) +
annotate("text",x=5.7,y=4,label=(paste("Slope =",round(coef(lm(time_mem_data$log_peak_memory[4:10]~time_mem_data$log_ncell[4:10]))[2], 3)))) +
annotate("text",x=4.3,y=4,label=(paste("Slope =",round(coef(lm(time_mem_data$log_peak_memory[1:3]~time_mem_data$log_ncell[1:3]))[2], 3))))
p3 <- ggarrange(p1, p2, nrow = 1,
labels = "auto")
ggsave("../../Supp_Fig5.jpeg", width = 8, height = 3,
units = "in", device='jpeg', dpi=600)
# Supp Fig 6
setwd("../../Numerical/SD1/data")
cluster_setting <- c("_cluster_seurat_k.rds", "_cluster_seurat_d.rds",
"_cluster_louvain_k.rds", "_cluster_louvain_d.rds",
"_cluster_cidr_k.rds", "_cluster_cidr_d.rds")
res <- matrix(0, 100, 6)
for (i in 1:100){
for (j in 1:6){
group <- readRDS(paste(i, cluster_setting[j], sep = ""))
res[i, j] <- adjustedRandIndex(group, rep(1:3, c(100, 4900, 1000)))
}
}
colnames(res) <- c("Seurat_N", "Seurat_D",
"Louvain_N", "Louvain_D",
"CIDR_N", "CIDR_D")
res <- data.frame(res)
plotdata <- pivot_longer(res, c("Seurat_N", "Seurat_D",
"Louvain_N", "Louvain_D",
"CIDR_N", "CIDR_D"))
colnames(plotdata) <- c("Setting", "ARI")
plotdata$Method <- rep(c("Seurat", "Seurat",
"Simple Louvain", "Simple Louvain",
"CIDR", "CIDR"), 100)
plotdata$Method <- factor(plotdata$Method, levels = c("Seurat", "Simple Louvain", "CIDR"))
plotdata$Setting <- factor(plotdata$Setting,
levels = c("Seurat_N", "Seurat_D",
"Louvain_N", "Louvain_D",
"CIDR_N", "CIDR_D"),
labels = c("Seurat_ON", "Seurat_TS",
"Louvain_ON", "Louvain_TS",
"CIDR_ON", "CIDR_TS"))
library(ggplot2)
ggplot(plotdata, aes(x=Setting, y=ARI, fill = Method)) +
geom_boxplot() + theme_bw() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) + ylab("ARI") + xlab("") +
theme(axis.text=element_text(size=12,face="bold"),
axis.title=element_text(size=14,face="bold"),
legend.text=element_text(size=12,face="bold"),
legend.title=element_text(size=14,face="bold"))
ggsave("../../../Supp_Fig6.jpeg", width = 4, height = 3,
units = "in", device='jpeg', dpi=600)
# Supp Fig 7
setwd("../../../Experimental/TCell/")
cell_annotation <- readRDS("OriginalData/multi_annotation.rds")
cellidx <- which(cell_annotation %in% c("CD8 Naive", "CD4 Naive",
"Intermediate B", "Memory B", "Naive B"))
data <- readRDS("OriginalData/multi_rna_data.rds")
data <- data[, cellidx]
genenames <- rownames(data)
rpc <- colSums(data)
idx <- which(rpc <= 1.8 * mean(rpc))
data <- data[, intersect(idx, idx)]
idx <- which(colSums(data > 0) > 0.02 * nrow(data))
data <- data[, idx]
idx <- which(rowSums(data > 0) > 0.02 * ncol(data))
data <- data[idx, ]
genenames <- genenames[idx]
so <- create_SiFINeT_object(data, gene.name = genenames)
so <- quantile_thres(so)
so <- feature_coexp(so)
data <- gmt2list("../../c7.all.v2023.1.Hs.symbols.gmt")
getwd()
data <- gmt2list("../../c7.all.v2023.1.Hs.symbols.gmt")
a <- names(data)
b1 <- grepl("TCELL_VS_BCELL_UP", a, fixed = TRUE)
d1 <- unlist(data[b1])
b2 <- grepl("TCELL_VS_BCELL_DN", a, fixed = TRUE)
d2 <- unlist(data[b2])
e1 <- table(d1)
upgenes <- names(e1)[e1 >= 2]
e2 <- table(d2)
dngenes <- names(e2)[e2 >= 2]
rm(a,b1,b2,d1,d2,e1,e2)
group1id <- match(tolower(upgenes), tolower(so@gene.name))
group1id <- group1id[!is.na(group1id)]
group2id <- match(tolower(dngenes), tolower(so@gene.name))
group2id <- group2id[!is.na(group2id)]
group3id <- c(group1id, group2id)
group4id <- setdiff(1:length(so@gene.name), group3id)
coexp <- so@coexp
rm(so)
a <- c(coexp[group1id, group1id][upper.tri(coexp[group1id, group1id])],
coexp[group2id, group2id][upper.tri(coexp[group2id, group2id])])
b <- c(coexp[group1id, group2id])
d <- c(coexp[group3id, group4id])
e <- c(coexp[group4id, group4id][upper.tri(coexp[group4id, group4id])])
da <- density(a)
db <- density(b)
dd <- density(d)
de <- density(e)
refx <- seq(-5, 5, length.out = length(da$x))
refy <- dnorm(refx)
plotx <- c(da$x, db$x, dd$x, de$x, refx)
ploty <- c(da$y, db$y, dd$y, de$y, refy)
label <- rep(c("Same", "Different", "One", "None", "Reference"),
c(length(da$x), length(db$x), length(dd$x), length(de$x), length(de$x)))
label <- factor(label, levels = c("Same", "Different", "One", "None", "Reference"))
plotdata <- data.frame(plotx, ploty, label)
plotdata <- plotdata[abs(plotdata$plotx) <= 10, ]
ggplot(plotdata, aes(plotx, ploty, color = label)) +
geom_line(size = 2, alpha = 0.5) + theme_bw() +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.title=element_blank()) +
labs(x = "Coexpression", y = "Density") +
scale_color_manual(values = c("yellow", "green", "red", "blue", "gray")) +
guides(fill=guide_legend(title="Coexpression type"))
ggsave("~/Downloads/Supp_fig7.jpeg", width = 4, height = 3,
units = "in", device='jpeg', dpi=600)
ggsave("../../Supp_fig7.jpeg", width = 4, height = 3,
units = "in", device='jpeg', dpi=600)
